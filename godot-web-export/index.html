<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forge of the Thousand Echoes</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #2c1810 0%, #1a0f08 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #f4e4c1;
        }
        
        #gameContainer {
            position: relative;
            width: 800px;
            height: 600px;
            background: #1a0f08;
            border: 3px solid #8b6914;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(139, 105, 20, 0.5);
        }
        
        canvas {
            display: block;
            border-radius: 7px;
        }
        
        #ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .ui-element {
            position: absolute;
            background: rgba(26, 15, 8, 0.9);
            border: 2px solid #8b6914;
            border-radius: 5px;
            padding: 10px;
            color: #f4e4c1;
            font-size: 14px;
            pointer-events: auto;
        }
        
        #score {
            top: 10px;
            left: 10px;
        }
        
        #materials {
            top: 60px;
            left: 10px;
        }
        
        #craftingPanel {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            display: none;
        }
        
        #echoPanel {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            display: none;
            text-align: center;
        }
        
        .button {
            background: #8b6914;
            color: #f4e4c1;
            border: none;
            padding: 8px 16px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .button:hover {
            background: #a67c17;
        }
        
        #startScreen, #victoryScreen, #defeatScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 15, 8, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        
        h1 {
            color: #f4e4c1;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .instructions {
            max-width: 400px;
            margin-bottom: 30px;
            line-height: 1.5;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        
        <div id="ui">
            <div id="score" class="ui-element">Score: 0</div>
            <div id="materials" class="ui-element">Materials:</div>
            
            <div id="craftingPanel" class="ui-element">
                <h3>Crafting Options</h3>
                <div id="craftingButtons"></div>
                <button class="button" onclick="closeCraftingPanel()">Close</button>
            </div>
            
            <div id="echoPanel" class="ui-element">
                <h3>Echo Discovered</h3>
                <p id="echoText"></p>
                <button class="button" onclick="closeEchoPanel()">Close</button>
            </div>
        </div>
        
        <div id="startScreen">
            <h1>Forge of the Thousand Echoes</h1>
            <div class="instructions">
                A narrative crafting RPG where weapons carry memories of past wielders.<br><br>
                Use WASD to move your blacksmith<br>
                Walk into forge stations to craft weapons<br>
                Discover echoes to unlock stories and abilities<br>
                Complete 5 crafting steps to forge a legendary weapon
            </div>
            <button class="button" onclick="startGame()">Start Forging</button>
            <button class="button" onclick="closeGame()">Close</button>
        </div>
        
        <div id="victoryScreen" class="hidden">
            <h1>Legendary Weapon Forged!</h1>
            <p id="finalScore">Final Score: 0</p>
            <p id="finalEchoes">Echoes Discovered: 0</p>
            <button class="button" onclick="restartGame()">Forge Again</button>
            <button class="button" onclick="mainMenu()">Main Menu</button>
            <button class="button" onclick="closeGame()">Close</button>
        </div>
        
        <div id="defeatScreen" class="hidden">
            <h1>Materials Depleted</h1>
            <p id="defeatScore">Final Score: 0</p>
            <button class="button" onclick="restartGame()">Try Again</button>
            <button class="button" onclick="mainMenu()">Main Menu</button>
            <button class="button" onclick="closeGame()">Close</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Game state
        let gameState = 'start';
        let score = 0;
        let materials = {
            'Iron Ore': 5,
            'Mystic Crystal': 2,
            'Ancient Wood': 3
        };
        let echoes = [];
        let craftingSteps = 0;
        let currentStation = null;
        
        // Player
        const player = {
            x: 400,
            y: 300,
            size: 30,
            speed: 3,
            color: '#cc9966'
        };
        
        // Forge stations
        const stations = [
            { name: 'Anvil', x: 150, y: 250, size: 40, color: '#808080' },
            { name: 'Grindstone', x: 400, y: 150, size: 40, color: '#b3b3b3' },
            { name: 'Quench Tank', x: 650, y: 250, size: 40, color: '#3366cc' }
        ];
        
        // Input handling
        const keys = {};
        document.addEventListener('keydown', (e) => keys[e.key.toLowerCase()] = true);
        document.addEventListener('keyup', (e) => keys[e.key.toLowerCase()] = false);
        
        function updatePlayer() {
            if (keys['w']) player.y -= player.speed;
            if (keys['s']) player.y += player.speed;
            if (keys['a']) player.x -= player.speed;
            if (keys['d']) player.x += player.speed;
            
            // Keep player in bounds
            player.x = Math.max(player.size/2, Math.min(canvas.width - player.size/2, player.x));
            player.y = Math.max(player.size/2, Math.min(canvas.height - player.size/2, player.y));
            
            // Check station collisions
            currentStation = null;
            for (const station of stations) {
                const dist = Math.sqrt(Math.pow(player.x - station.x, 2) + Math.pow(player.y - station.y, 2));
                if (dist < (player.size + station.size) / 2) {
                    currentStation = station;
                    showCraftingPanel(station.name);
                    break;
                }
            }
            
            if (!currentStation) {
                closeCraftingPanel();
            }
        }
        
        function draw() {
            // Clear canvas
            ctx.fillStyle = '#2c1810';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw forge floor pattern
            ctx.strokeStyle = '#1a0f08';
            ctx.lineWidth = 2;
            for (let i = 0; i < canvas.width; i += 50) {
                ctx.beginPath();
                ctx.moveTo(i, 0);
                ctx.lineTo(i, canvas.height);
                ctx.stroke();
            }
            for (let i = 0; i < canvas.height; i += 50) {
                ctx.beginPath();
                ctx.moveTo(0, i);
                ctx.lineTo(canvas.width, i);
                ctx.stroke();
            }
            
            // Draw stations
            for (const station of stations) {
                ctx.fillStyle = station.color;
                ctx.fillRect(station.x - station.size/2, station.y - station.size/2, station.size, station.size);
                
                // Station label
                ctx.fillStyle = '#f4e4c1';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(station.name, station.x, station.y - station.size/2 - 5);
            }
            
            // Draw player
            ctx.fillStyle = player.color;
            ctx.fillRect(player.x - player.size/2, player.y - player.size/2, player.size, player.size);
            
            // Draw player highlight if near station
            if (currentStation) {
                ctx.strokeStyle = '#f4e4c1';
                ctx.lineWidth = 2;
                ctx.strokeRect(player.x - player.size/2 - 2, player.y - player.size/2 - 2, player.size + 4, player.size + 4);
            }
        }
        
        function updateUI() {
            document.getElementById('score').textContent = `Score: ${score}`;
            
            let materialsText = 'Materials:\n';
            for (const [material, amount] of Object.entries(materials)) {
                materialsText += `${material}: ${amount}\n`;
            }
            document.getElementById('materials').textContent = materialsText;
        }
        
        function showCraftingPanel(stationName) {
            const panel = document.getElementById('craftingPanel');
            const buttonsDiv = document.getElementById('craftingButtons');
            
            panel.style.display = 'block';
            buttonsDiv.innerHTML = '';
            
            const options = getCraftingOptions(stationName);
            for (const option of options) {
                const btn = document.createElement('button');
                btn.className = 'button';
                btn.textContent = option.text;
                btn.onclick = () => performCrafting(option.action);
                buttonsDiv.appendChild(btn);
            }
        }
        
        function

function closeCraftingPanel() {
            document.getElementById('craftingPanel').style.display = 'none';
        }
        
        function getCraftingOptions(stationName) {
            const options = [];
            switch(stationName) {
                case 'Anvil':
                    options.push({ text: 'Forge Blade', action: 'forge_blade' });
                    options.push({ text: 'Forge Hammer', action: 'forge_hammer' });
                    break;
                case 'Grindstone':
                    options.push({ text: 'Sharpen Weapon', action: 'sharpen' });
                    options.push({ text: 'Polish Edge', action: 'polish' });
                    break;
                case 'Quench Tank':
                    options.push({ text: 'Quench in Water', action: 'water_quench' });
                    options.push({ text: 'Quench in Oil', action: 'oil_quench' });
                    break;
            }
            return options;
        }
        
        function performCrafting(action) {
            let success = false;
            let echoText = '';
            
            switch(action) {
                case 'forge_blade':
                    if (materials['Iron Ore'] >= 2) {
                        materials['Iron Ore'] -= 2;
                        score += 100;
                        echoText = 'The blade remembers a knight\'s final stand...';
                        success = true;
                    }
                    break;
                case 'forge_hammer':
                    if (materials['Iron Ore'] >= 3 && materials['Ancient Wood'] >= 1) {
                        materials['Iron Ore'] -= 3;
                        materials['Ancient Wood'] -= 1;
                        score += 150;
                        echoText = 'This hammer once shattered the gates of an ancient fortress...';
                        success = true;
                    }
                    break;
                case 'sharpen':
                    score += 50;
                    echoText = 'A warrior\'s prayer echoes from the edge...';
                    success = true;
                    break;
                case 'polish':
                    score += 75;
                    echoText = 'The reflection shows faces of past wielders...';
                    success = true;
                    break;
                case 'water_quench':
                    score += 60;
                    echoText = 'Steam rises like the breath of a dragon...';
                    success = true;
                    break;
                case 'oil_quench':
                    score += 80;
                    echoText = 'The oil preserves memories of ancient battles...';
                    success = true;
                    break;
            }
            
            if (success) {
                craftingSteps++;
                echoes.push(echoText);
                showEchoPanel(echoText);
                updateUI();
                
                // Check victory condition
                if (craftingSteps >= 5) {
                    showVictoryScreen();
                }
                
                // Check defeat condition
                let totalMaterials = Object.values(materials).reduce((sum, amount) => sum + amount, 0);
                if (totalMaterials === 0 && craftingSteps < 5) {
                    showDefeatScreen();
                }
            }
            
            closeCraftingPanel();
        }
        
        function showEchoPanel(echoText) {
            const panel = document.getElementById('echoPanel');
            document.getElementById('echoText').textContent = echoText;
            panel.style.display = 'block';
        }
        
        function closeEchoPanel() {
            document.getElementById('echoPanel').style.display = 'none';
        }
        
        function startGame() {
            gameState = 'playing';
            document.getElementById('startScreen').classList.add('hidden');
            gameLoop();
        }
        
        function showVictoryScreen() {
            gameState = 'victory';
            document.getElementById('finalScore').textContent = `Final Score: ${score}`;
            document.getElementById('finalEchoes').textContent = `Echoes Discovered: ${echoes.length}`;
            document.getElementById('victoryScreen').classList.remove('hidden');
        }
        
        function showDefeatScreen() {
            gameState = 'defeat';
            document.getElementById('defeatScore').textContent = `Final Score: ${score}`;
            document.getElementById('defeatScreen').classList.remove('hidden');
        }
        
        function restartGame() {
            // Reset game state
            score = 0;
            materials = {
                'Iron Ore': 5,
                'Mystic Crystal': 2,
                'Ancient Wood': 3
            };
            echoes = [];
            craftingSteps = 0;
            player.x = 400;
            player.y = 300;
            
            // Hide all screens
            document.getElementById('victoryScreen').classList.add('hidden');
            document.getElementById('defeatScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.add('hidden');
            
            gameState = 'playing';
            updateUI();
            gameLoop();
        }
        
        function mainMenu() {
            gameState = 'start';
            document.getElementById('victoryScreen').classList.add('hidden');
            document.getElementById('defeatScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
            closeCraftingPanel();
            closeEchoPanel();
        }
        
        function closeGame() {
            // In a real implementation, this would close the game
            document.body.innerHTML = '<div style="text-align: center; margin-top: 200px; color: #f4e4c1;"><h2>Game Closed</h2><p>Thank you for playing Forge of the Thousand Echoes</p></div>';
        }
        
        function gameLoop() {
            if (gameState === 'playing') {
                updatePlayer();
                draw();
                requestAnimationFrame(gameLoop);
            }
        }
        
        // Initialize
        updateUI();
    </script>